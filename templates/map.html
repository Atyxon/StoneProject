{% load static %}
{{ stones|json_script:"stones-data" }}
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mapa kamieni</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
      /* Loader full-page */
      #loader {
        position: fixed;
        top:0; left:0;
        width:100%; height:100%;
        background:white;
        display:flex;
        justify-content:center;
        align-items:center;
        z-index:999999;
      }

      .spinner {
        border:6px solid #eee;
        border-top:6px solid #333;
        border-radius:50%;
        width:50px; height:50px;
        animation:spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform:rotate(0deg); }
        100% { transform:rotate(360deg); }
      }

      /* Page content hidden by default using opacity */
      .page-content {
        opacity:0;
        transition: opacity 0.6s ease;
      }
      .page-content.loaded {
        opacity:1;
      }

      /* Make map fill container */
      .stone-map, #map {
        width:100%;
        height:100vh; /* full viewport height */
      }
    </style>
</head>
<body>
    <!-- LOADER -->
    <div id="loader">
        <div class="spinner"></div>
    </div>

    <!-- Cała strona -->
    <div class="page-content">
        {% include "partials/header.html" %}

        <div class="stone-map">
            <div id="map"></div>
        </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
          var stones = JSON.parse(document.getElementById('stones-data').textContent);
          var lat = 50.0647, lng = 19.9450;

          // Inicjalizacja mapy
          var map = L.map('map').setView([lat, lng], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '© OpenStreetMap'
          }).addTo(map);

          function createMarker(iconUrl){
              return L.icon({
                  iconUrl: iconUrl,
                  iconSize: window.innerWidth < 600 ? [48,48]:[64,64],
                  iconAnchor: window.innerWidth < 600 ? [24,48]:[32,64],
                  popupAnchor:[0,-42]
              });
          }

          var marker = createMarker('/static/app_images/marker.png');
          var marker_green = createMarker('/static/app_images/marker_green.png');

          stones.forEach(function(stone){
              var iconToUse = stone.found ? marker_green : marker;
              L.marker([stone.latitude,stone.longitude], {icon:iconToUse})
               .addTo(map)
               .bindPopup('<a href="/'+stone.id+'">'+stone.title+'</a>');
          });

          // Resize marker icons on window resize
          window.addEventListener('resize', function() {
              map.eachLayer(function(layer) {
                  if (layer instanceof L.Marker) {
                      var iconToUse = layer.options.icon.options.iconUrl.includes('green') ? marker_green : marker;
                      layer.setIcon(createMarker(iconToUse.options.iconUrl));
                  }
              });
          });

          // Funkcja kończąca loader
          function finishLoading(){
              document.getElementById('loader').style.display='none';
              document.querySelector('.page-content').classList.add('loaded');
              // Odśwież mapę dopiero gdy kontener widoczny
              setTimeout(()=>{ map.invalidateSize(); }, 300);
          }

          // Czekaj aż wszystkie obrazki w DOM się załadują
          const imgs = Array.from(document.images);
          let loaded = 0;
          if(imgs.length===0) finishLoading();
          imgs.forEach(img=>{
              if(img.complete){ loaded++; if(loaded===imgs.length) finishLoading(); }
              else { img.addEventListener('load', check); img.addEventListener('error', check); }
          });
          function check(){ loaded++; if(loaded===imgs.length) finishLoading(); }
      });
    </script>
</body>
</html>
