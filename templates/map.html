{% load static %}
{{ stones|json_script:"stones-data" }}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mapa kamieni</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</head>
<body>
    {% include "partials/header.html" %}

        <div class="stone-map">
            <div id="map" style="width: 100%; height: 100%;"></div>
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    var stones = JSON.parse(document.getElementById('stones-data').textContent);
                    var lat = 50.0647;
                    var lng = 19.9450;

                    var map = L.map('map').setView([lat, lng], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap'
                    }).addTo(map);

                    function createMarker(iconUrl) {
                        return L.icon({
                            iconUrl: iconUrl,
                            iconSize: window.innerWidth < 600 ? [48, 48] : [64, 64],
                            iconAnchor: window.innerWidth < 600 ? [24, 48] : [32, 64],
                            popupAnchor: [0, -42]
                        });
                    }

                    var marker = createMarker('/static/app_images/marker.png');
                    var marker_green = createMarker('/static/app_images/marker_green.png');

                    stones.forEach(function(stone) {
                        var iconToUse = stone.found ? marker_green : marker;
                        L.marker([stone.latitude, stone.longitude], { icon: iconToUse })
                            .addTo(map)
                            .bindPopup('<a href="/' + stone.id + '">' + stone.title + '</a>');
                    });

                    setTimeout(function () {
                        map.invalidateSize();
                    }, 100);

                    // Recalculate marker sizes on window resize
                    window.addEventListener('resize', function() {
                        map.eachLayer(function(layer) {
                            if (layer instanceof L.Marker) {
                                var iconToUse = layer.options.icon.options.iconUrl.includes('green') ? marker_green : marker;
                                layer.setIcon(createMarker(iconToUse.options.iconUrl));
                            }
                        });
                    });
                });
            </script>
        </div>
</body>
</html>
