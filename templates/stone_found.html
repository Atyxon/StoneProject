{% load static %}
{% load l10n %}
{% load humanize %}
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Kamie≈Ñ odnaleziony!</title>
<link rel="stylesheet" href="{% static 'styles.css' %}">
<link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
    :root {
        --brand: #4CAF50;
        --card: rgba(255,255,255,.5);
        --shadow: 0 10px 25px rgba(0,0,0,.08);
        --radius: 16px;
    }
    body { margin:0; font-family: Arial,sans-serif; position: relative; }
    header, .site-header { width: 100%; z-index: 10001; position: relative; }

    /* Loader */
    #loader {
        position: fixed; inset: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background: white;
        z-index: 99999;
    }
    .spinner {
        border:6px solid #eee;
        border-top:6px solid #333;
        border-radius:50%;
        width:50px;
        height:50px;
        animation:spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform:rotate(0deg);} 100% { transform:rotate(360deg);} }

    .page-content { opacity:0; transition: opacity 0.5s ease; }
    .page-content.loaded { opacity:1; }

    main.page { display:flex; justify-content:center; padding:8px; }
    .card {
        width:100%; max-width:760px; background:var(--card);
        border-radius:var(--radius); box-shadow:var(--shadow);
        padding:10px; text-align:center; box-sizing:border-box;
    }
    h1 { margin:6px 0 2px; font-size: clamp(24px,5vw,32px); color: var(--brand);}
    .congrats { font-size: clamp(18px,4vw,22px); color:#2e7d32; margin:6px 0 18px; font-weight:700; }

    /* Stone container */
    .stone-container {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 16px;
        flex-wrap: nowrap;
        background: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 16px;
        padding: 16px;
        margin: 0 0 14px auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        max-width: 600px;
    }
    .stone-image-container {
        flex: 0 0 120px;
        width: 180px;
        aspect-ratio: 1/1;
        overflow: hidden;
        border-radius: 12px;
        box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    .stone-image-container img {
        width: 100%; height: 100%; object-fit: cover; display: block;
    }
    .stone-info { flex: 1; text-align: left; min-width: 0; align-self: flex-start;}
    .stone-info h3,h4 { margin: 5px 0; word-break: break-word; }

    @media(max-width:600px){
        .stone-container { flex-direction: row; align-items: center; gap: 12px; }
        .stone-image-container { flex: 0 0 150px; width: 150px; }
        .stone-info h3 { font-size: 22px; margin: 0; margin-bottom: 15px; text-align: center;}
        .stone-info h4 { font-size: 14px; margin: 0; margin-bottom: 5px; }
    }

    .comment-form { margin-top:5px; padding:16px; border-radius:12px; background:#fafafa; border:1px solid #eee; text-align:left; box-sizing:border-box; }
    .comment-form h3 { margin-bottom:10px; margin-top: 0px}
    .comment-form textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #ddd;
        margin-bottom: 8px;
        font: inherit;
    }
    .comment-form input[type="text"] {
        width: 75%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #ddd;
        margin-bottom: 8px;
        font: inherit;
    }
    .row { display:flex; justify-content:flex-end; flex-wrap:wrap; gap:12px; }

    /* File container */
    .file-container {
        position:relative; width:50%; max-width:50%; aspect-ratio:1/1;
        border:3px dashed var(--brand); border-radius:16px; display:flex;
        justify-content:center; align-items:center; background:#fff; margin:0 auto 1rem 0; overflow:hidden;
        cursor: pointer;
        transition: background 0.2s ease;
    }
    .file-container:hover { background: rgba(76,175,80,0.05); }
    .plus-sign {
        font-size: 64px; color: var(--brand);
        user-select: none; transition: transform 0.2s ease;
        pointer-events: none;
    }
    .file-container:hover .plus-sign { transform: scale(1.1); }
    .file-container img.preview {
        position:absolute; top:0; left:0; width:100%; height:100%;
        object-fit:cover; display:none;
    }
    .cancel-btn {
        position:absolute; top:8px; right:8px; width:32px; height:32px;
        background:rgba(0,0,0,0.6); color:white; border:none; border-radius:50%;
        font-size:18px; font-weight:bold; text-align:center; line-height:32px;
        display:none; cursor:pointer; z-index:3;
    }

    .comment-form button[type="submit"] {
        padding:10px 20px; border-radius:8px; border:none; background:#333;
        color:white; cursor:pointer; transition:0.3s;
    }
    .comment-form button[type="submit"]:hover { background:#555; }

    /* Popup Modal */
    .modal-overlay {
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal {
        background: white;
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        width: 90%;
        max-width: 360px;
        box-shadow: var(--shadow);
        position: relative;
        animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .modal h4 { margin-top: 0; color: var(--brand); }
    .modal button {
        padding:10px 16px;
        border-radius:8px;
        border:none;
        background:var(--brand);
        color:white;
        font-size:1rem;
        font-weight:600;
        cursor:pointer;
        width: 80%;
        margin: 8px 0;
    }
    .modal button:hover { background:#43a047; }
    .modal .close-modal {
        position: absolute;
        top: 10px; right: 10px;
        background: none; border: none; font-size: 22px; cursor: pointer;
    }

    canvas#confetti { position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:9999; }
</style>
</head>
<body>
    {% include "partials/header.html" %}

    <!-- Loader -->
    <div id="loader"><div class="spinner"></div></div>

    <!-- Page Content -->
    <div class="page-content">
        <main class="page" aria-live="polite">
            <section class="card">
                <h1>Gratulacje!</h1>
                <p class="congrats">Uda≈Ço Ci siƒô odnale≈∫ƒá kamie≈Ñ</p>

                <div class="stone-container">
                    <div class="stone-image-container">
                        <img src="{{ stone.image.url }}" alt="{{ stone.title }}">
                    </div>
                    <div class="stone-info">
                        <h3 class="stone-title">{{ stone.title }}</h3>
                        <h4 class="stone-meta" id="foundDate">üìÖ</h4>
                        <h4 class="stone-meta" id="locationName">üìç</h4>
                    </div>
                </div>

                <div class="comment-form">
                    <h3>Zostaw po sobie komentarz!</h3>
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="file-container" id="fileContainer">
                            <div class="plus-sign" id="plusSign">+</div>
                            <img class="preview" id="imagePreview">
                            <button type="button" class="cancel-btn" id="cancelBtn">√ó</button>
                            <input type="file" name="image" id="fileInput" accept="image/*" style="display:none;">
                        </div>
                        <input type="text" name="author" placeholder="Twoje imiƒô">
                        <textarea name="text" placeholder="Napisz komentarz..." rows="3"></textarea>
                        <div class="row">
                            <button type="submit">Dodaj komentarz</button>
                        </div>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Confetti Canvas -->
    <canvas id="confetti"></canvas>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <button class="close-modal" id="closeModal">√ó</button>
            <h4>üì∏ Wybierz ≈∫r√≥d≈Ço zdjƒôcia</h4>
            <p>Chcesz zrobiƒá zdjƒôcie czy wybraƒá z pamiƒôci?</p>
            <button id="chooseCamera">Zr√≥b zdjƒôcie</button>
            <button id="chooseGallery">Wybierz z pamiƒôci</button>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
    // Loader
    window.addEventListener('load', () => {
        document.getElementById('loader').style.display = 'none';
        document.querySelector('.page-content').classList.add('loaded');

        // Launch confetti
        const myConfetti = confetti.create(document.getElementById('confetti'), { resize: true });
        myConfetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 }
        });
    });

    // File and modal handling
    const fileContainer = document.getElementById('fileContainer');
    const fileInput = document.getElementById('fileInput');
    const imagePreview = document.getElementById('imagePreview');
    const cancelBtn = document.getElementById('cancelBtn');
    const plusSign = document.getElementById('plusSign');
    const modalOverlay = document.getElementById('modalOverlay');
    const closeModal = document.getElementById('closeModal');
    const chooseCamera = document.getElementById('chooseCamera');
    const chooseGallery = document.getElementById('chooseGallery');

    // Open modal when user clicks "+"
    fileContainer.addEventListener('click', () => {
        if (!fileInput.value) {
            modalOverlay.style.display = 'flex';
        }
    });

    // Close modal when clicking close button or background
    closeModal.addEventListener('click', () => modalOverlay.style.display = 'none');
    modalOverlay.addEventListener('click', e => {
        if (e.target === modalOverlay) modalOverlay.style.display = 'none';
    });

    // Choose Camera
    chooseCamera.addEventListener('click', () => {
        modalOverlay.style.display = 'none';
        fileInput.setAttribute('capture', 'environment');
        fileInput.click();
    });

    // Choose Gallery
    chooseGallery.addEventListener('click', () => {
        modalOverlay.style.display = 'none';
        fileInput.removeAttribute('capture');
        fileInput.click();
    });

    // File preview
    fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
            modalOverlay.style.display = 'none'; // auto-hide modal after selection
            const reader = new FileReader();
            reader.onload = function(evt){
                imagePreview.src = evt.target.result;
                imagePreview.style.display = 'block';
                cancelBtn.style.display = 'block';
                plusSign.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    });

    // Cancel preview
    cancelBtn.addEventListener('click', e => {
        e.stopPropagation();
        fileInput.value = '';
        imagePreview.style.display = 'none';
        cancelBtn.style.display = 'none';
        plusSign.style.display = 'block';
    });

    // Date display
    const foundDate = document.getElementById('foundDate');
    const today = new Date();
    const formattedDate = today.toLocaleDateString('pl-PL', { year: 'numeric', month: 'long', day: 'numeric' });
    foundDate.textContent = `üìÖ ${formattedDate}`;

    // Reverse geocoding
    const locationName = document.getElementById('locationName');
    const latitude = {{ stone.latitude|unlocalize }};
    const longitude = {{ stone.longitude|unlocalize }};

    async function getLocationName(lat, lon) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
            const data = await response.json();
            locationName.textContent = `üìç ${data.address.city || data.address.town || data.address.village || data.address.county || 'Nieznana'}`;
        } catch (error) {
            locationName.textContent = 'üìç Nieznana';
            console.error('B≈ÇƒÖd podczas pobierania lokalizacji:', error);
        }
    }

    getLocationName(latitude, longitude);
</script>
</body>
</html>
