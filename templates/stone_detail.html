{% load static %}
{% load l10n %}
{% load humanize %}
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ stone.title }}</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
    body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
    }

    .stone-wrapper {
        width: 100%;
        max-width: 900px;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin: 0 auto;
    }

    .stone-box,
    .comments-box,
    .finder-comment-box {
        max-width: 100%;
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .stone-box h1,
    .comments-box h2,
    .finder-comment-box h2 {
        margin-top: 0;
        font-size: 1.5rem;
    }

    .stone-top {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 1.5rem;
    }

    .stone-image,
    .stone-map {
        flex: 1;
        min-width: 280px;
        max-width: 100%;
        aspect-ratio: 1/1;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    .stone-image img,
    .stone-map img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    #map {
        width: 100%;
        height: 100%;
        border-radius: 12px;
    }

    #open-google-maps {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000;
        padding: 8px 12px;
        background-color: #4285F4;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .comment-form textarea,
    .comment-form input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-bottom: 5px;
        font-size: 1rem;
        box-sizing: border-box;
    }

    .comment-form textarea { resize: none; }
    .comment-form button {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        background: #333;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.3s;
        margin-left: auto;
    }
    .comment-form button:hover { background: #555; }

    .stone-status { margin-top: 1rem; font-size: 1rem; }

    .comment {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1rem;
        padding: 0.5rem;
        border-radius: 8px;
        background: #f9f9f9;
        gap: 0.75rem;
    }
    .comment-avatar img {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        background: #ddd;
    }
    .comment-body { flex: 1; }
    .comment-author { font-weight: bold; margin-bottom: 0.25rem; font-size: 0.95rem; }
    .comment-time { color: gray; font-weight: normal; font-size: 0.8rem; margin-left: 0.5rem; }
    .no-comments { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; text-align: center;}

    /* Finder comment section */
    .finder-comment-box .finder-comment {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        flex-wrap: wrap;
        background: #f9f9f9;
        border-radius: 8px;
        padding: 0.75rem;
    }

    .finder-comment .comment-avatar img {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        background: #ddd;
    }

    .finder-comment-body {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-width: 200px;
    }

    .finder-comment-image {
        width: 100%;
        max-width: 400px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .finder-comment-image img {
        width: 100%;
        height: auto;
        object-fit: cover;
        display: block;
    }

    @media (max-width: 1024px) {
        .stone-top { flex-direction: column; }
        .stone-image, .stone-map { width: 100%; height: auto; }
        #map { width: 100%; height: 100%; }
    }

    @media (max-width: 600px) {
        .stone-box, .comments-box, .finder-comment-box { padding: 1rem; }
        .stone-box h1 { font-size: 1.25rem; }

        /* Keep avatar + author + text inline */
        .finder-comment {
            flex-wrap: wrap;
            align-items: flex-start;
        }
        .finder-comment-body {
            flex: 1 1 0;
            min-width: 0;
        }
        .finder-comment-image {
            width: 100%;
            max-width: 100%;
            margin-top: 8px;
        }

        .comment-form input { max-width: 100%; }
    }
    </style>
</head>
<body>
    {% include "partials/header.html" %}

    <div class="main-content">
        <div class="stone-wrapper">
            <div class="stone-box">
                <h1>{{ stone.title }}</h1>

                <div class="stone-top">
                    <div class="stone-image">
                        <img src="{% if stone.image %}{{ stone.image.url }}{% else %}{% static 'app_images/no_image.jpeg' %}{% endif %}" alt="{{ stone.title }}">
                    </div>

                    <div class="stone-map">
                        <div id="map"></div>
                        <button id="open-google-maps">Otw√≥rz w Google Maps</button>
                        <script>
                        document.addEventListener("DOMContentLoaded", function () {
                            var lat = {{ stone.latitude|unlocalize }};
                            var lng = {{ stone.longitude|unlocalize }};
                            var map = L.map('map').setView([lat, lng], 13);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '¬© OpenStreetMap'
                            }).addTo(map);

                            var marker = L.icon({ iconUrl: '/static/app_images/marker.png', iconSize: [48,48], iconAnchor: [24,48], popupAnchor: [0,-32] });
                            var marker_green = L.icon({ iconUrl: '/static/app_images/marker_green.png', iconSize: [48,48], iconAnchor: [24,48], popupAnchor: [0,-32] });

                            var iconToUse = {{ stone.found|yesno:"true,false" }} ? marker_green : marker;
                            L.marker([lat, lng], { icon: iconToUse }).addTo(map).bindPopup('{{ stone.title|escapejs }}');

                            setTimeout(function () { map.invalidateSize(); }, 100);

                            document.getElementById("open-google-maps").addEventListener("click", function() {
                                window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lng}`, "_blank");
                            });
                        });
                        </script>
                    </div>
                </div>

                <div class="stone-info">
                    <p>{{ stone.description }}</p>
                    <div class="stone-status">
                        {% if stone.found %}
                            <span style="color: green;">‚úÖ Znaleziony</span>
                            <p>üïí Znaleziono: {{ stone.found_at|date:"j E Y" }}</p>
                        {% else %}
                            <span style="color: red;">‚ùå Nie znaleziony</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if stone.finder_comment %}
            <div class="finder-comment-box">
                <h2>Komentarz znalazcy</h2>
                <div class="finder-comment">

                    <div class="comment-avatar">
                        <img src="{% static 'app_images/profile.png' %}" alt="avatar">
                    </div>

                    <div class="finder-comment-body">
                        <div class="comment-author">{{ stone.finder_comment.author }}</div>
                        <div style="overflow-wrap: break-word; word-break: break-word;">{{ stone.finder_comment.text }}</div>
                    </div>

                    {% if stone.finder_comment.image %}
                    <div class="finder-comment-image">
                        <img src="{{ stone.finder_comment.image.url }}" alt="Zdjƒôcie znalazcy">
                    </div>
                    {% endif %}

                </div>
            </div>
            {% endif %}

            <div class="comments-box">
                <form method="post" class="comment-form">
                    {% csrf_token %}
                    {{ form.author }}
                    {{ form.text }}
                    <div class="row">
                        <button type="submit">Dodaj komentarz</button>
                    </div>
                    <br>
                </form>

                {% if comments %}
                    {% for comment in comments %}
                        <div class="comment">
                            <div class="comment-avatar">
                                <img src="{% static 'app_images/profile.png' %}" alt="avatar">
                            </div>
                            <div class="comment-body">
                                <div class="comment-author">
                                    {{ comment.author }}
                                    <small class="comment-time">{{ comment.created_at|naturaltime }}</small>
                                </div>
                                <div class="comment-text" style="overflow-wrap: break-word; word-break: break-word;">{{ comment.text }}</div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="no-comments">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 16 16" style="filter: drop-shadow(0 0 0 rgba(0, 0, 0, 0))">
                            <path fill="currentColor" d="m11.293 12l2.853 2.854a.5.5 0 0 0 .708-.708l-13-13a.5.5 0 1 0-.708.708l.739.738A2.5 2.5 0 0 0 1 4.5v5A2.5 2.5 0 0 0 3.5 12H4v1.942a.98.98 0 0 0 1.625.738L8.688 12zM15 9.5c0 .916-.492 1.716-1.227 2.152L4.121 2H12.5A2.5 2.5 0 0 1 15 4.5z"/>
                        </svg>
                        <p>Brak komentarzy</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const authorInput = document.getElementById("author-input");

            if (authorInput) {
                const savedName = localStorage.getItem("stone_author_name");
                if (savedName) authorInput.value = savedName;

                const form = authorInput.closest("form");
                form.addEventListener("submit", function() {
                    localStorage.setItem("stone_author_name", authorInput.value);
                });
            }
        });
    </script>
</body>
</html>
